<!DOCTYPE html>
<html>
  <head>
      <link rel="stylesheet" href="css/framework.css">
      <link rel="stylesheet" href="css/main.css">
      <script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/riot-route@x.x.x/dist/route.min.js"></script>
      <script src="js/mustache.min.js"></script>
      <script src="js/framework.js"></script>
  </head>

  <body>

    <!-- TARGETS -->
    <div class="menu">
      TRADING ROBOTS
      <target name="menu"></target>
    </div>
    <div class="main">
      <target name="main"></target>
    </div>
    <div class="sheet">
      <target name="sheet"></target>
    </div>


    <!-- HOME -->
    <component name="strategy_index">
      <a href="#/strategy/{{id}}">
        <div> {{ name }} </div>
        <div> {{ lastname }} </div>
      </a>
    </component>

    <!-- STRATEGY -->
    <component name="text">
      <div> {{content}} </div>
    </component>

    <component name="strategy_show">
      <div> This is my Strategy </div>
    </component>

    <component name="button">
      <div class="button button-g" onclick="{{func.name}}('{{func.param}}')"> {{label}} </div>
    </component>


    <script type="text/javascript">

      $(document).ready( ()=> {
        framex.init(params)
        /// TO REMOVE : permet le rafraichissement par F5 pour test
        route('/')
        params.pages[0].action()
      })

      const Pages = {
          list_of_strategies: async () => {
            framex.reset()
            let data = await framex.source('strategy/list')
              console.log(data)
            data.list.forEach( s => {
              framex.write('main', 'strategy_index', { name: s.name, id:s.id})
            })
          },

          strategy_view: async (strat_id) => {
            framex.reset()
            let data = await framex.source('strategy/view/'+strat_id)

            framex.write('main', 'strategy_show')
            framex.write('main', 'button', {label:'Backtest', func: { name:'backtest_worker', param: strat_id } })
            framex.write('main', 'button', {label:'start_worker', func: strat_id })
          },

          run_page: async() => {

          },

          backtest_wait: async(id) => {
            framex.reset()
            framex.write('main', 'text', {content: 'BACKTEST IN PROGRESS ...'})

            // Start listening to new change
            let ret = await framex.waitFor('worker/status/'+id)
            route('/backtest/result/'+id)
          },

          backtest_result: async(id) => {
            framex.reset()
            framex.write('main', 'text', {content: ' BACKTEST '+id+' RESULT'})

            let data = await framex.source('backtest/result/'+id)
            console.log(data)

          }

      }

      function start_worker(strategy) {
        strat = strategy || 'strategy01'
        $.get(url+'strategy/run/'+strat, res => {
          console.log(res)
        })
      }

      async function backtest_worker(strategyId) {
        let result = await framex.source('worker/backtest/'+strategyId)
        let workerId = result.id
        route('/backtest/wait/'+workerId) // go to wait page
      }

      const params = {
        pages: [
          { route:'/', action: Pages.list_of_strategies },
          { route: '/strategy../*', action: Pages.strategy_view },
          { route: '/backtest/wait../*', action: Pages.backtest_wait },
          { route: '/backtest/result../*', action: Pages.backtest_result },
        ]
      }

    </script>

    <style type="text/css">
      component{
        display:none;
      }
    </style>
  </body>



</html>